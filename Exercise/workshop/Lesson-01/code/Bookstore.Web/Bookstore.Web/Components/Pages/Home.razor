@page "/"
@using Bookstore.Shared
@using Bookstore.Web.Clients
@inject BookstoreClient BookstoreClient
@inject NavigationManager Navigation
@attribute [StreamRendering]
@rendermode InteractiveServer

<PageTitle>Bookstore - Home</PageTitle>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-4">Welcome to Our Bookstore</h1>
        <a href="/cart" class="btn btn-outline-primary">
            <i class="bi bi-cart"></i> Cart (@cart?.TotalItems ?? 0)
        </a>
    </div>

    @if (books == null)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading books...</p>
        </div>
    }
    else if (books.Length == 0)
    {
        <div class="alert alert-info">
            <h4>No books available</h4>
            <p>Check back soon for new arrivals!</p>
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var book in books)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <img src="@book.ImageUrl" class="card-img-top" alt="@book.Title" style="height: 300px; object-fit: cover;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@book.Title</h5>
                            <h6 class="card-subtitle mb-2 text-muted">by @book.Author</h6>
                            <p class="card-text flex-grow-1">@book.Description</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="h5 mb-0 text-primary">@book.Price.ToString("C")</span>
                                <span class="badge bg-secondary">Stock: @book.Stock</span>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0">
                            <button class="btn btn-primary w-100"
                                    @onclick="() => AddToCart(book)"
                                    disabled="@(book.Stock <= 0)">
                                @if (book.Stock > 0)
                                {
                                    <text><i class="bi bi-cart-plus"></i> Add to Cart</text>
                                }
                                else
                                {
                                    <text>Out of Stock</text>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @if (showSuccessMessage)
    {
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
            <div class="toast show" role="alert">
                <div class="toast-header bg-success text-white">
                    <strong class="me-auto">Success</strong>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showSuccessMessage = false"></button>
                </div>
                <div class="toast-body">
                    Book added to cart!
                </div>
            </div>
        </div>
    }
</div>

@code {
    private Book[]? books;
    private Bookstore.Shared.Cart? cart;
    private bool showSuccessMessage;
    private string cartId = "default-cart";

    protected override async Task OnInitializedAsync()
    {
        books = await BookstoreClient.GetBooksAsync();
        cart = await BookstoreClient.GetCartAsync(cartId);
    }

    private async Task AddToCart(Book book)
    {
        var cartItem = new CartItem
        {
            BookId = book.Id,
            Book = book,
            Quantity = 1
        };

        cart = await BookstoreClient.AddToCartAsync(cartId, cartItem);
        showSuccessMessage = true;
        StateHasChanged();
        await Task.Delay(3000);
        showSuccessMessage = false;
        StateHasChanged();
    }
}
